{% extends "tramites/tramites.html" %}
{% block title %} Lista Tramites {% endblock %}

{% block tramites_content %}
<section class="">
    <h2 class="mb-3 text-dark text-center">Lista de Trámites</h2>
    <form method="get" class="mb-3">
        <div class="row">
            <div class="col-md-5">
                <label for="cliente" class="mt-2">Filtrar por Cliente:</label>
                <select name="cliente" id="cliente" class="form-select">
                    <option value="">-- Todos los clientes --</option>
                    {% for cliente in clientes %}
                        <option value="{{ cliente.cliente_id }}" {% if cliente_seleccionado == cliente.cliente_id|stringformat:"s" %}selected{% endif %}>
                            {{ cliente.nombre }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-5">
                <label for="proyecto" class="mt-2">Filtrar por Proyecto:</label>
                <select name="proyecto" id="proyectoSelect" class="form-select">
                    <option value="">-- Todos los proyectos --</option>
                    {% for proyecto in proyectos %}
                        <option value="{{ proyecto.proyecto_id }}" {% if proyecto_seleccionado == proyecto.proyecto_id|stringformat:"s" %}selected{% endif %}>
                            {{ proyecto.nombre }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-2 d-flex justify-content-center align-items-end">
                <button type="submit" class="btn btn-primary w-100">Filtrar</button>
            </div>
        </div>

    </form>

    <table class="table table-striped table-bordered align-middle">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Proyecto</th>
                <th>Nombre</th>
                <th>Dependencia</th>
                <th>Responsable</th>
                <th>Inicio</th>
                <th>Fin</th>
                <th>Total</th>
                <th>Pagado</th>
                <th>Saldo</th>
                <th>Estatus</th>
            </tr>
        </thead>
        <tbody>
            {% for tramite in tramites %}
            <tr>
                <td>{{ tramite.tramite_id }}</td>
                <td>{{ tramite.proyecto }}</td>
                <td>{{ tramite.nombre }}</td>
                <td>{{ tramite.dependencia }}</td>
                <td>{{ tramite.responsable_dependencia }}</td>
                <td>{{ tramite.fecha_inicio }}</td>
                <td>{{ tramite.fecha_fin|default:"N/A" }}</td>
                <td>${{ tramite.total_tramite }}</td>
                <td>${{ tramite.total_pagado }}</td>
                <td>${{ tramite.saldo_pendiente }}</td>
                <td>{{ tramite.estatus }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="11" class="text-center">No hay trámites disponibles.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Paginación -->
    <nav aria-label="Paginación de trámites">
        <ul class="pagination justify-content-center">
            {% if tramites.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page=1{% if proyecto_seleccionado %}&proyecto={{ proyecto_seleccionado }}{% endif %}">« Primero</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ tramites.previous_page_number }}{% if proyecto_seleccionado %}&proyecto={{ proyecto_seleccionado }}{% endif %}">‹ Anterior</a>
            </li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">« Primero</span></li>
            <li class="page-item disabled"><span class="page-link">‹ Anterior</span></li>
            {% endif %}

            <li class="page-item active"><span class="page-link">{{ tramites.number }}</span></li>

            {% if tramites.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ tramites.next_page_number }}{% if proyecto_seleccionado %}&proyecto={{ proyecto_seleccionado }}{% endif %}">Siguiente ›</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ tramites.paginator.num_pages }}{% if proyecto_seleccionado %}&proyecto={{ proyecto_seleccionado }}{% endif %}">Último »</a>
            </li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">Siguiente ›</span></li>
            <li class="page-item disabled"><span class="page-link">Último »</span></li>
            {% endif %}
        </ul>
    </nav>

    <!-- Dashboard -->
    <!-- Dashboard KPIs -->
    <section class="mb-5 mt-4">
        <div class="row g-4 justify-content-center">
            <!-- Trámites Totales -->
            <div class="col-lg-3">
                <div class="dashboard-card text-dark">
                    <div class="dashboard-body text-center">
                        <div class="dashboard-title display-5">{{ total_tramites }}</div>
                        <div class="subtitle">Total Trámites</div>
                    </div>
                </div>
            </div>
            <!-- Trámites Activos -->
            <div class="col-lg-3">
                <div class="dashboard-card text-dark">
                    <div class="dashboard-body text-center">
                        <div class="dashboard-title display-5">{{ activos }}</div>
                        <div class="subtitle">Trámites Activos</div>
                    </div>
                </div>
            </div>
            <!-- Monto Total -->
            <div class="col-lg-3">
                <div class="dashboard-card text-dark">
                    <div class="dashboard-body text-center">
                        <div class="dashboard-title display-5">${{ monto_total|floatformat:2 }}</div>
                        <div class="subtitle">Monto Total</div>
                    </div>
                </div>
            </div>
            <!-- Total Pagado -->
            <div class="col-lg-3">
                <div class="dashboard-card text-dark">
                    <div class="dashboard-body text-center">
                        <div class="dashboard-title display-5">${{ total_pagado|floatformat:2 }}</div>
                        <div class="subtitle">Total Pagado</div>
                    </div>
                </div>
            </div>
            <!-- % Completado -->
            <div class="col-lg-3">
                <div class="dashboard-card text-dark">
                    <div class="dashboard-body text-center">
                        <div class="dashboard-title display-5">{{ porcentaje_completado }}%</div>
                        <div class="subtitle">Trámites Completados</div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="graphic-card text-dark">
                    <div class="graphic-body">
                        <h5 class="subtitle">Estatus de trámites</h5>
                        <canvas id="chartEstadoTramites"></canvas>
                    </div>
                </div>
            </div>

        </div>
    </section>

</section>

<script>
    document.getElementById('cliente').addEventListener('change', function () {
        const clienteId = this.value;
        const proyectoSelect = document.getElementById('proyectoSelect');

        proyectoSelect.innerHTML = '<option value="">Cargando proyectos...</option>';

        let url = '/tramites/proyectos_por_cliente/';
        if (clienteId) {
            url += `?cliente_id=${clienteId}`;
        }

        fetch(url)
            .then(response => response.json())
            .then(data => {
                proyectoSelect.innerHTML = '<option value="">-- Selecciona un proyecto --</option>';
                data.proyectos.forEach(proyecto => {
                    const option = document.createElement('option');
                    option.value = proyecto.proyecto_id;
                    option.textContent = proyecto.nombre;
                    proyectoSelect.appendChild(option);
                });
            })
            .catch(() => {
                proyectoSelect.innerHTML = '<option value="">Error cargando proyectos</option>';
            });
    });
    

</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const ctx = document.getElementById('chartEstadoTramites');
    const chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: {{ labels_estatus|safe }},
            datasets: [{
                label: 'Cantidad',
                data: {{ cantidades_estatus|safe }},
                backgroundColor: ['#0d6efd', '#198754', '#ffc107', '#dc3545'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { precision: 0 }
                }
            }
        }
    });
</script>
{% endblock %}
